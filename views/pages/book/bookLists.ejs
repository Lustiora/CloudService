<div class="row mt-5 justify-content-end">
  <div class="col-6 col-md-4">
    <form id="f_title">
      <div class="input-group">
        <input type="text" id="query" name="query" class="form-control" value="" />
        <button class="btn btn-success" type="submit"> Search </button>
      </div>
    </form>
  </div>
</div>
<hr />

<!-- 검색 결과 출력 영역 -->
<div id="list_book" class="row"></div>

<!-- Handlebars 템플릿 -->
<script type="text/x-handlebars-template" id="temp-book">
  {{#each documents}}
    <div class="col-6 col-md-4 col-lg-2">
      <div class="card my-2">
        <div class="card-body text-center">
          <img src="{{image thumbnail}}" index="{{@index}}" alt="도서이미지" style="cursor:pointer; width:80%" />
          <div class="ellipsis mt-2">{{title}}</div>
        </div>
        <div class="card-footer text-center" style="font-size:0.9rem;">
          {{format price}}
          <span class="cart ms-3" book="{{book @this}}" style="cursor:pointer; color:green;">CART</span>
        </div>
      </div>
      <%-include("bookModal.ejs") %>
    </div>
  {{/each}}
</script>

<!-- Handlebars 헬퍼 등록 -->
<script>
  Handlebars.registerHelper("image", function(thum) {
    return thum || "https://placehold.co/120x174";
  });
  Handlebars.registerHelper("format", function(price) {
    return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') + '원';
  });
  Handlebars.registerHelper("book", function(book) {
    return JSON.stringify(book);
  });
</script>

<script type="module">
  // handlebars가 documents(Array(10))를 빙글빙글 돌면서
  // 카드레이아웃 하나 + 모달 하나가 같이 찍히는 구조
  // 즉 카드 하나당 모달 하나를 가지도록 설계
  // 카드 이미지를 클릭 => index/book data이용하여 모달을 호출
  // 모달 내용은 bookModal.ejs에 있음
  // 이미지에는 index="{{@index}}"를 넣어서 몇번째 칙인지를 JS에서 알수있도록 함
  // include("bookModal.ejs")를 통해 EJS에서 모달 창 HTML을
  // 카드마다 삽입해 두고 나중에 JS로 모달을 열어서 상세 정보를 볼 수 있게 한다.
  // 장바구니 이벤트와 이미지 클릭시 상세보기 Modal을 호출하여 상세내용을 확인하고
  // 장바구니 담기 버튼을 누른다.
  // 두가지를 같이 처리할 수 있도록 이벤트 핸들러 함수를 설계한다.
  const listEl = document.querySelector("#list_book")
  // 목록 영역 클릭 이벤트(장바구니 & 이미지 Modal)
  listEl.addEventListener('click', function(e){
    const target = e.target
    // location.href("/bookModal.ejs")
    // Cart를 클릭했을때
    if(target.classList.contains('cart')){
      console.log("cart");
    }
    // 이미지를 클릭 했을때
    if(target.tagName == 'IMG'){ // tagName 비교시 소문자로 작성되었더라도 대문자로 비교해야함
      console.log("image");
      const index = target.getAttribute('index') // 0, 1, ~ , 9
      console.log(index);
      const modalEl = document.querySelector(`modal${index}`)
      if(modalEl && window.bootstrap){
        // index.ejs에 bootstrap객체가 import되어 있으므로 사용이 가능함
        // bootstrap이 제공하는 Modal객체를 생성하고 그 객체가 제공하는
        // show() 호출하여 화면에 모달이 출력되게 한다.
        const modal = new bootstrap.Modal(modalEl)
        modal.show()
      } // end of inner if
    } // end of outner if
  })


  // 검색전 디폴트 페이지가 출력되도록 query는 null, undefined가 되지않도록 할것
  let query = document.querySelector("#query").value // 자바가 담김
  // 사용자가 입력한 책 제목으로 검색하기
  // 검색폼 제출하기 (submit이슈)
  document.querySelector("#f_title").addEventListener('submit', function(e){
    e.preventDefault()
    query = document.querySelector("#query").value;
    const page = 1
    getBookList(query,page)
  })
  // 도서 리스트 조회
    function getBookList(query,page){
      console.log(query); // 검색어 콘솔로
    const url = new URL('https://dapi.kakao.com/v3/search/book')
    url.searchParams.set('target','title')
    url.searchParams.set('query', query)
    url.searchParams.set('page', page)
    fetch(url, {
      headers:{
        "Authorization":"KakaoAK 4061ebc2f92294d9be224173dcd52dd5"
      }
    })
      .then((response) => response.json())
      .then((data) => {
        console.log(data);
        //핸들바스템플릿 가져오기
        const source = document.querySelector("#temp-book").innerHTML
        //템플릿 컴파일 - 매핑(데이터와 테이블태그 머지)
        const template = Handlebars.compile(source)
        //데이터와 html렌더링
        const html = template(data)
        //결과 출력
        document.querySelector("#list_book").innerHTML = html
      })
      .catch((error) => console.error(error));
    } // end of getBookList
    getBookList(query,1)
</script>